# NSNSDAcoustics

This repository provides a place for NSNSD staff to develop and modernize several bioacoustics workflows, including,

1) `wave_to_nvspl`: a wrapper function for PAMGuide code that converts wave audio to NVSPLs.
2) `nvspl_to_ai`: a function for converting NVSPL files into acoustic indices
3) The BirdNET function family: several functions for manipulation of [BirdNET data](https://birdnet.cornell.edu/).

Contributors should clone this repository (set it up as an R project package) and connect it to GitHub (see [Happy Git with R](https://happygitwithr.com/) for tips). While the package is in development, use the Build > Install and Restart buttons in RStudio to install the package locally on your machine.

**All documentation and code is currently under development.**

## Installing NSNSDAcoustics

First, ensure that you have installed the latest versions of [R](https://cran.r-project.org/) and [RStudio](https://www.rstudio.com/products/rstudio/download/). 

Next, install NSNSDAcoustics using `install_github()` function from the R package `devtools`.

```r
devtools::install_github('nationalparkservice/NSNSDAcoustics')
```

If `install_github()` doesn't work, you can download the zip or tar.gz file directly using one of the following links. 
* Windows users can download the zip file from NSNSDAcoustics-master.zip **need to create link**
* Mac or Linux users can download the tar.gz file from NSNSDAcoustcs-master.tar.gz **need to create link**

After downloading, open R Studio, click on the Install button on the Packages tab, select Install From Package Archive File, and navigate to the downloaded file.

## A note on data.table syntax
NSNSDAcoustics depends on the R package `data.table`, which allows for fast querying and manipulation of large data.frames. If you are an R user but have never used `data.table` syntax before, some of the example code may look unfamiliar. Don't fret -- `data.table` object types are also  `data.frames`. If you get frustrated by trying to subset them, you can always convert your `data.table` object type to a regular `data.frame` to work with a more familiar object type.

## Converting wave audio files to NVSPL with `wave_to_nvspl()`

Define NVSPLs. What are they and why do we convert to them?

First, pull up the documentation file for this function:
```r
?wave_to_nvspl
```

`wave_to_nvspl()` uses PAMGuide code to convert wave files into NVSPL format. PAMGuide was developed by Nathan D. Merchant et al. 2015 (**ADD LINKS**). The suggested workflow for this function is to first set test.file = TRUE to test that your workflow has been accurately parameterize. Next, to batch process NVSPLs for many audio files, run with test.file = FALSE.

```r
# Create an input directory for this example
dir.create('example-input-directory')

# Read in example wave files
data(exampleAudio1)
data(exampleAudio2)

# Write example waves to example input directory
tuneR::writeWave(object = exampleAudio1,
                 filename = 'example-input-directory/Rivendell_20210715_114502.wav')
tuneR::writeWave(object = exampleAudio2,
                 filename = 'example-input-directory/Rivendell_20210715_115502.wav')

# Perform wave_to_nvspl in test mode (test.file = TRUE)
wave_to_nvspl(
 input.directory = 'example-input-directory',
 data.directory = FALSE,
 test.file = TRUE,
 project = 'testproject',
 timezone = 'GMT')

# Perform wave_to_nvspl in batch mode (test.file = FALSE)
wave_to_nvspl(
 input.directory = 'example-input-directory',
 data.directory = FALSE,
 test.file = FALSE,
 project = 'testproject',
 timezone = 'GMT')

# Verify that NVSPL outputs have been created
nvspls <- list.files('example-input-directory/NVSPL', full.names = TRUE)

# View one of the NVSPL outputs
one.nvspl <- read.delim(file = nvspls[1], sep = ',')

# Delete all temporary example files when finished
unlink(x = 'example-input-directory', recursive = TRUE)

```

## Converting NVSPL files to acoustic indices with `nvspl_to_ai()`

Explain about 1/3 octave bands.
Why use this wave --> NVSPL --> acoustic indices workflow instead of using existing acoustic index functions that take wave data directly?

First, pull up the documentation file for this function:
```r
?nvspl_to_ai
```

`nvspl_to_ai()` converts NVSPLs (generated by PAMGuide via `wave_to_nvspl`) into a range of acoustic indices. The examples below demonstrate how to use this function. When the start.at.beginning argument is set to TRUE (**DESCRIBE**); when start.at.beginning = FALSE (**DESCRIBE**)

```r

# Create an input and output directory for this example
dir.create('example-input-directory')
dir.create('example-output-directory')

# Read in example NVSPL data
data(exampleNVSPL)

# Write example NVSPL data to example input directory
for (i in 1:length(exampleNVSPL)) {
write.table(x = exampleNVSPL[[i]],
            file = paste0('example-input-directory/', names(exampleNVSPL)[i]),
            sep = ',',
            quote = FALSE)
}

# Run nvspl_to_ai to generate acoustic indices csv for example NVSPL files,
# setting start.at.beginning = FALSE
nvspl_to_ai(input.directory = 'example-input-directory',
            output.directory = 'example-output-directory',
            project = 'example-project',
            start.at.beginning = FALSE)

# Run nvspl_to_ai to generate acoustic indices csv for example NVSPL files,
# setting start.at.beginning = TRUE
nvspl_to_ai(input.directory = 'example-input-directory',
            output.directory = 'example-output-directory',
            project = 'example-project',
            start.at.beginning = TRUE)

# Read in both files to compare
start.standard <- read.csv(list.files(path = './example-output-directory/',
                                     pattern = 'Index_Created',
                                     full.names = TRUE))
start.begin <- read.csv(list.files(path = './example-output-directory/',
                                     pattern = 'Begin_Created',
                                     full.names = TRUE))

# View a few rows of each file; note the Hr, Min, Sec differences between both options
start.standard[1:4, ]
start.begin[1:4, ]

# Delete all temporary example files when finished
unlink(x = 'example-input-directory', recursive = TRUE)
unlink(x = 'example-output-directory', recursive = TRUE)


```

## Using `birdnet_run()` to process audio data through [BirdNET](https://birdnet.cornell.edu/)

`birdnet_run()` will not work unless you have BirdNET installed and have made necessary modifications. This function uses the reticulate package to run Python from RStudio in order to process files through BirdNET. It assumes that all files in a folder come from the same site, and that the audio files are wave format and follow a SITEID_YYYYMMDD_HHMMSS.wav naming convention. To use `birdnet_run()`, users must first successfully install [BirdNET-Lite](https://github.com/kahst/BirdNET-Lite), set up [a conda environment for BirdNET](https://github.com/cbalantic/cbalantic.github.io/blob/master/_posts/2022-03-07-Install-BirdNET-Windows-RStudio.md#1-set-up-a-conda-environment), and save [a modified version of the BirdNET analyze.py file](https://github.com/cbalantic/cbalantic.github.io/blob/master/_posts/2022-03-07-Install-BirdNET-Windows-RStudio.md#3-modify-the-birdnet-analyze-script). If you're on a Windows machine, [see here](https://github.com/cbalantic/cbalantic.github.io/blob/master/_posts/2022-03-07-Install-BirdNET-Windows-RStudio.md) for a way to install BirdNET onto a Windows machine and running it from RStudio.

Please input absolute paths for all directory arguments in `birdnet_run()`. This is necessary due to the way RStudio is communicating with the underlying Python code. Note that the option to input a customized species list has not been implemented in this function.

**If you don't want to go to the trouble of installing BirdNET, you can still view example data to get an idea of the raw CSV outputs produced by BirdNET-Lite:**
```r
# View examples of CSV outputs produced by birdnet_run(): 

data(exampleBirdNET1)
write.csv(x = exampleBirdNET1,
          file = 'BirdNET_Rivendell_20210623_113602.csv',
          row.names = FALSE)

data(exampleBirdNET2)
write.csv(x = exampleBirdNET2,
          file = 'BirdNET_Rivendell_20210623_114602.csv',
          row.names = FALSE)

```

If you **do** want to run BirdNET from R, the following pseudocode provides an outline for how to implement `birdnet_run()`. Because this function uses two external programs (Python and BirdNET-Lite), the example function below will not be modifiable to run for you unless you have installed BirdNET-Lite, set up a conda environment, and modified the `analyze.py` file as described above. 


```r

# Must set environment BEFORE calling in the reticulate package
Sys.setenv(RETICULATE_PYTHON = "C:/Your/Python/Path/Here/python.exe")
library(reticulate)

# Set your conda environment
use_condaenv(condaenv = "pybirdnet", required = TRUE)

# Create an audio directory for this example
dir.create('example-audio-directory')

# Create a results directory for this example
dir.create('example-results-directory')

# Read in example wave files
data(exampleAudio1)
data(exampleAudio2)

# Write example waves to example audio directory
tuneR::writeWave(object = exampleAudio1,
                 filename = 'example-audio-directory/Rivendell_20210623_113602.wav')
tuneR::writeWave(object = exampleAudio2,
                 filename = 'example-audio-directory/Rivendell_20210623_114602.wav')

# Run audio data through BirdNET
birdnet_run(audio.directory = 'absolute/path/to/example-audio-directory',
            results.directory = 'absolute/path/to/example-results-directory',
            birdnet.directory = 'absolute/path/to/BirdNET',
            birdnet.script = 'BirdNET-Reticulate.py',
            lat = 46.09924,
            lon = -123.8765)

# Delete all temporary example files when finished
unlink(x = 'example-audio-directory', recursive = TRUE)
unlink(x = 'example-results-directory', recursive = TRUE)
```

You may not want to process files through RStudio, or you may already have BirdNET-Lite CSV results in hand that you would like to begin analyzing, in which case you can skip ahead to the next functions. 

## Using `birdnet_*()` functions to assess BirdNET results

* `birdnet_format_csv()` reformats the raw BirdNET results...
* `birdnet_gather_results()` gathers all BirdNET CSV results from a desired folder into a user-friendly data.table / data.frame
* `birdnet_species_counts()` summarizes count data from a data.table of detected species over a selected time unit
* `birdnet_verify()` allows the user to manually verify a selected subset of detections based on a user-input library of classification options 
